# 数据库维护脚本

## 清理重复订单数据脚本

### 文件位置
`scripts/clean-duplicate-orders.js`

### 功能说明
此脚本用于检查和清理 `product_sales_orders` 表中的重复数据。

根据唯一性约束 `(shopId, productId, salesDate)`,对于重复的订单记录:
- ✅ **保留**: ID 最大(最新)的记录
- ❌ **删除**: 其他旧的重复记录

### 使用方法

#### 1. 仅检查重复数据(不删除)
```bash
node scripts/clean-duplicate-orders.js --dry-run
```

这个命令会:
- 检查数据库中是否有重复订单
- 显示详细的重复记录信息
- **不会删除任何数据**

#### 2. 交互式清理(推荐)
```bash
node scripts/clean-duplicate-orders.js
```

这个命令会:
- 检查并显示重复数据
- 询问你是否确认执行清理
- 输入 `yes` 后才会删除数据

#### 3. 强制清理(无需确认)
```bash
node scripts/clean-duplicate-orders.js --force
```

⚠️ **警告**: 此命令会直接删除重复数据,不会请求确认!

### 执行流程

```
1. 连接数据库
   ↓
2. 检查是否存在重复数据
   ↓
3. 显示重复数据详情
   ├─ 组别信息 (shopId, productId, salesDate)
   ├─ 每条记录的 ID 和创建时间
   └─ 标注哪条保留,哪条删除
   ↓
4. (--dry-run 模式到此结束)
   ↓
5. 请求用户确认 (--force 跳过此步)
   ↓
6. 执行删除操作 (使用事务)
   ↓
7. 验证清理结果
   ↓
8. 显示成功消息
```

### 输出示例

```
============================================
订单数据重复清理脚本
============================================

正在检查重复订单...

⚠️  发现 2 组重复的订单数据:

1. 重复组:
   - 店铺ID: shop123
   - 商品ID: prod456
   - 销售日期: 2024-01-01
   - 重复数量: 3 条记录

   记录详情:
     ✅ 保留 | ID: 150 | 创建: 2024-01-01T15:30:00.000Z | 数量: 100
     ❌ 删除 | ID: 145 | 创建: 2024-01-01T14:20:00.000Z | 数量: 95
     ❌ 删除 | ID: 140 | 创建: 2024-01-01T13:10:00.000Z | 数量: 90

总结:
- 发现 2 组重复数据
- 将删除 4 条旧记录
- 将保留 2 条最新记录

是否继续执行清理? (输入 yes 确认): yes

开始清理重复数据...

✓ 清理完成: shopId=shop123, productId=prod456, salesDate=2024-01-01, 删除 2 条
✓ 清理完成: shopId=shop789, productId=prod012, salesDate=2024-01-02, 删除 2 条

✅ 清理完成! 共删除 4 条重复记录

✅ 验证通过: 数据库中已无重复数据
```

### 安全性

✅ **事务保护**: 所有删除操作在事务中执行,出错会自动回滚

✅ **数据备份**: 建议在执行前备份数据库:
```bash
cp data/merchants.db data/merchants.db.backup
```

✅ **试运行模式**: 使用 `--dry-run` 可以安全地查看将被删除的数据

### 注意事项

1. **执行时机**: 建议在低峰期执行,避免影响线上服务
2. **数据备份**: 首次执行前务必备份数据库
3. **日志查看**: 脚本会输出详细的清理日志,请保存备查

### 自动清理机制

除了手动运行此脚本,系统在数据库初始化时也会自动执行清理:

- **位置**: `src/lib/sqlite-db.ts` → `migrateAddUniqueIndex()` 方法
- **时机**: 创建唯一索引之前
- **原理**: 调用 `cleanDuplicateOrders()` 方法自动清理

因此,在部署新代码后,系统会在首次启动时自动清理重复数据。

### 故障排查

**问题**: 提示 "未找到 product_sales_orders 表"
- **原因**: 数据库未初始化或表名错误
- **解决**: 先启动应用以初始化数据库

**问题**: 清理后仍有重复数据
- **原因**: 可能是并发写入导致
- **解决**: 再次运行脚本,或检查代码中的唯一性约束

**问题**: 脚本执行报错
- **原因**: 数据库文件损坏或权限问题
- **解决**: 检查数据库文件完整性和访问权限
